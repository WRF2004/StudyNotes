## P5_CPU设计文档及思考题

### 设计

顶层为mips，mips由Process(转发)、Stall(暂停)、PC、IM、FDreg、Decode、DEreg、Execute、EMreg、Memory、MWreg、Writeback模块组成。

#### Process(转发)

| 端口名称  | 方向 | 位宽 | 描述                          |
| --------- | ---- | ---- | ----------------------------- |
| clk       | I    | 1    | 时钟信号                      |
| reset     | I    | 1    | 复位信号                      |
| d_instr   | I    | 32   | D级指令                       |
| d_rd1     | I    | 32   | D级GRF寄存器第一个输出值      |
| d_rd2     | I    | 32   | D级GRF寄存器第二个输出值      |
| FW_d_d1   | O    | 32   | 转发到D级的第一个值           |
| FW_d_d2   | O    | 32   | 转发到D级的第二个值           |
| e_instr   | I    | 32   | E级指令                       |
| e_rd1     | I    | 32   | E级寄存器第一个输出值         |
| e_rd2     | I    | 32   | E级寄存器第二个输出值         |
| e_out     | I    | 32   | E级寄存器输出值，用于转发     |
| e_a3      | I    | 5    | E级A3寄存器地址，用于转发判断 |
| FW_e_d1   | O    | 32   | 转发到E级的第一个值           |
| FW_e_d2   | O    | 32   | 转发到E级的第二个值           |
| m_instr   | I    | 32   | M级指令                       |
| m_out     | I    | 32   | M级寄存器输出值，用于转发     |
| m_a3      | I    | 5    | M级A3寄存器地址，用于转发判断 |
| m_DMinput | I    | 32   | 流水到M级rt寄存器的值         |
| FW_m_d    | O    | 32   | 转发到M级的值，用于DM输入     |
| w_instr   | I    | 32   | W级指令                       |
| w_out     | I    | 32   | W级寄存器输出，用于转发       |
| w_a3      | I    | 5    | M级A3寄存器地址，用于转发判断 |

#### Stall(暂停)

| 端口名称 | 方向 | 位宽 | 描述                            |
| -------- | ---- | ---- | ------------------------------- |
| d_instr  | I    | 32   | D级指令                         |
| e_instr  | I    | 32   | E级指令                         |
| m_instr  | I    | 32   | M级指令                         |
| e_a3     | I    | 5    | E级A3寄存器地址，用于暂停判断   |
| m_a3     | I    | 5    | M级A3寄存器的地址，用于暂停判断 |
| e_out    | I    | 32   | E级寄存器输出，用于暂停判断     |
| m_out    | I    | 32   | M级寄存器输出，用于暂停判断     |
| fd_stall | O    | 1    | PC和FDreg暂停信号               |
| de_stall | O    | 1    | DEreg刷新信号                   |
| em_stall | O    | 1    | DEreg暂停信号，EMreg刷新信号    |

#### FDreg

| 端口名称 | 方向 | 位宽 | 描述     |
| -------- | ---- | ---- | -------- |
| clk      | I    | 1    | 时钟信号 |
| reset    | I    | 1    | 复位信号 |
| fd_stall | I    | 1    | 暂停信号 |
| f_instr  | I    | 32   | F级指令  |
| f_pc     | I    | 32   | F级pc值  |
| d_instr  | O    | 32   | D级指令  |
| d_pc     | O    | 32   | D级pc值  |

#### DEreg

| 端口名称   | 方向 | 位宽 | 描述                |
| ---------- | ---- | ---- | ------------------- |
| clk        | I    | 1    | 时钟信号            |
| reset      | I    | 1    | 复位信号            |
| d_instr    | I    | 32   | D级指令             |
| ext_imm32d | I    | 32   | D级输出的立即数扩展 |
| d_pc       | I    | 32   | D级pc值             |
| FW_d_d1    | I    | 32   | D级A1转发值         |
| FW_d_d2    | I    | 32   | D级A2转发值         |
| d_a3       | I    | 5    | D级A3地址           |
| de_out     | I    | 32   | D级寄存器输出       |
| de_stall   | I    | 1    | DEreg刷新信号       |
| em_stall   | I    | 1    | DEreg暂停信号       |
| e_a3       | O    | 5    | E级A3地址           |
| e_pc       | O    | 32   | E级pc值             |
| e_rd1      | O    | 32   | E级寄存器输出的A1值 |
| e_rd2      | O    | 32   | E级寄存器输出的A2值 |
| e_instr    | O    | 32   | E级指令             |
| ext_imm32e | O    | 32   | E级扩展的立即数     |
| e_out      | O    | 32   | E级寄存器输出值     |

#### EMreg

| 端口名称  | 方向 | 位宽 | 描述                             |
| --------- | ---- | ---- | -------------------------------- |
| clk       | I    | 1    | 时钟信号                         |
| reset     | I    | 1    | 复位信号                         |
| e_a3      | I    | 5    | E级A3地址                        |
| e_aluout  | I    | 32   | E级ALU计算结果                   |
| e_pc      | I    | 32   | E级pc值                          |
| e_instr   | I    | 32   | E级指令                          |
| e_DMinput | I    | 32   | E级输出A2寄存器的值，用于M级输入 |
| em_out    | I    | 32   | E级输出                          |
| em_stall  | I    | 1    | EMreg刷新信号                    |
| m_a3      | O    | 5    | M级A3值                          |
| m_aluout  | O    | 32   | ALU计算的结果传到M级             |
| m_pc      | O    | 32   | M级pc值                          |
| m_instr   | O    | 32   | M级指令                          |
| m_out     | O    | 32   | M级寄存器输出值                  |
| m_DMinput | O    | 32   | A2寄存器的值，用于后续DM输入     |

### 转发设计

#### 确定转发值

首先需要确定要转发的值，哪里要用寄存器的值，哪里就需要转发。因此，可以知道D级有两处转发(jr和beq)，E级有两处转发(ALU计算)，M级有一处转发(sw输入DM)。

#### 转发策略

如果后一级A3地址与本级需要用到的寄存器的地址相同，并且下一级的A3寄存器的值需要写入(we等于1)，则将下一级寄存器的输出值转发。

若下一级不满足上述条件，就看下下一级，一直到W级。

### 暂停设计

#### 暂停的情况

如果本级需要用到的寄存器与下一级A3相同，但是下一级寄存器的输出值为高阻态(结果还未算出)，此时则需要暂停。

#### 暂停信号

* fd_stall : 当流水线中出现需要暂停的情况时，pc和FDreg需要停止工作。
* de_stall : 当D级需要暂停时，DEreg需要刷新。
* em_stall : 当E级需要暂停时，DEreg需要暂停，EMreg需要刷新。

### 思考题

> 1. 我们使用提前分支判断的方法尽早产生结果来减少因不确定而带来的开销，但实际上这种方法并非总能提高效率，请从流水线冒险的角度思考其原因并给出一个指令序列的例子。

如果正在执行的指令需要使用在 D 级阶段进行的分支判断的结果，但该结果尚未准备好，那么流水线将被阻塞，直到分支判断的结果可用。这时流水线将停止，影响性能。

```
add $t0, $t1, $t2
beq $t0, $t1, loop
```

> 2. 因为延迟槽的存在，对于 jal 等需要将指令地址写入寄存器的指令，要写回 PC + 8，请思考为什么这样设计？

因为延迟槽的存在在分支指令之后的一条指令会被执行，不论分支条件如何，所以需要跳过下一条指令，故需要多加4.

> 3. 我们要求所有转发数据都来源于流水寄存器而不能是功能部件（如 DM、ALU），请思考为什么？

因为功能部件计算出结果所需的数据也可能来源于转发，这会导致流水线潜在的不稳定。

> 4. 我们为什么要使用 GPR 内部转发？该如何实现？

因为D级读取的寄存器可能与W级回写的寄存器是同一个，故寄存器的值需要改变。实现方法：当读寄存器时的地址与同周期写寄存器的地址相同时，我们将读取的内容改为写寄存器的内容，而不是该地址可以索引到的寄存器文件中的值。

> 5. 我们转发时数据的需求者和供给者可能来源于哪些位置？共有哪些转发数据通路？

需求者：D级beq和jr指令、E级ALU计算、M级DM数据输入

供给者：E级寄存器的输出、M级寄存器的输出、W级寄存器的输出

转发数据通路：E级寄存器输出、M级寄存器的输出、W级寄存器的输出转发给D级；M级寄存器的输出、W级寄存器的输出转发给E级；W级寄存器的输出转发给M级。

> 6. 在课上测试时，我们需要你现场实现新的指令，对于这些新的指令，你可能需要在原有的数据通路上做哪些扩展或修改？提示：你可以对指令进行分类，思考每一类指令可能修改或扩展哪些位置。

跳转类指令须在D级修改，计算类须在E级，load类须在M级。

> 7. 简要描述你的译码器架构，并思考该架构的优势以及不足。

我使用的是分布式译码器，需要时就可以使用，优势在于灵活，不足在于重复过多。